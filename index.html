<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>rotaty</title>

  <script type='text/nonsense' class='before'>
(function($, payload){
  if ($) {
    return payload($);
  }

  var script = document.createElement( 'script' );
  script.type = 'text/javascript';
  script.src = 'http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js';

  var readystate;

  script.onload = script.onreadystatechange = function() {
    if ( !(readystate = this.readyState) || readystate == 'loaded' || readystate == 'complete') {
      payload(window.jQuery);

      window.jQuery(script).remove();
    }
  };

  document.documentElement.childNodes[0].appendChild( script );
})(window.jQuery, function($) {
  $(document).ready(function () {
  </script>

  <script type="text/nonsense" class='after'>
  });
});
  </script>

  <script type="text/nonsense" class='rotaty-css'>
* {
  transition: transform 1s;
}
.BOOKMARKLET_NAME {
  transform: rotate(360deg);
}
  </script>

  <script type="text/nonsense" class='mirrory-css'>
* {
  transition: transform 1s;
}
.BOOKMARKLET_NAME {
  transform: rotateY(180deg);
}
  </script>

  <script type="text/nonsense" class='flippy-css'>
* {
  transition: transform 1s;
}
.BOOKMARKLET_NAME {
  transform: rotate(180deg);
}
  </script>

  <script type="text/nonsense" class='turnover-css'>
* {
  transition: transform 1s;
}
.BOOKMARKLET_NAME {
  transform: rotateX(180deg);
}
  </script>

  <script type="text/nonsense" class='trippy-css'>
* {
  transition: background-color 1s, color 1s;
}
  </script>

  <script type="text/nonsense" class='zotaty-css'>
.BOOKMARKLET_NAME {
  animation-iteration-count: infinite;
  animation-duration: 1s;
  animation-name: rotateForever;
  animation-timing-function: linear;
}

@keyframes rotateForever {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(360deg);
  }
}
  </script>

  <script type="text/nonsense" class='zoshaky-css'>
.BOOKMARKLET_NAME {
  animation-iteration-count: infinite;
  animation-duration: 1s;
  animation-name: shakeForever;
  animation-timing-function: linear;
}

@keyframes shakeForever {
  0% {
    transform: rotate(0deg);
  }

  5% {
    transform: rotate(5deg);
  }

  15% {
    transform: rotate(-5deg);
  }

  20% {
    transform: rotate(0deg);
  }
}
  </script>

  <script type="text/nonsense" class='blurry-css'>
.BOOKMARKLET_NAME {
  filter: blur(5px);
}
  </script>

  <script type="text/nonsense" class='inverty-css'>
.BOOKMARKLET_NAME {
  filter: invert(100%);
}
  </script>

  <script type="text/nonsense" class='rotaty-js'>
var selector = '*:visible';
var delay = 1000;

setInterval(function () {
  var allStuff = $(selector);
  var randomIndex = Math.floor(Math.random() * allStuff.length);
  allStuff.eq(randomIndex).toggleClass('BOOKMARKLET_NAME')
}, delay);
  </script>

  <script type="text/nonsense" class='trippy-js'>
var selector = '*:visible';
var delay = 1000;

function randomColor() {
  return Math.floor(Math.random() * 255);
}

setInterval(function () {
  var allStuff = $(selector);
  var randomIndex = Math.floor(Math.random() * allStuff.length);

  var prop = (Math.random() > 0.5) ? 'color' : 'background-color';
  var color = 'rgb(' + randomColor() + ', ' + randomColor() + ', ' + randomColor() + ')';

  allStuff.eq(randomIndex).css(prop, color);
}, delay);
  </script>

  <script type="text/nonsense" class='zotaty-js'>
var $hoveredElement;
$(document).on('mouseover', function (event) {
  $hoveredElement = $(event.target);
});
$(document).on('keypress', function (event) {
  if (event.which === 'TRIGGER_KEY'.charCodeAt(0)) {
    $hoveredElement.toggleClass('BOOKMARKLET_NAME');
  }
});
  </script>

  <link rel='stylesheet' href='style.css'></link>

  <script src="crunch.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

  <script>
    var vendoredProperties = /\b(animation|keyframes|filter)\b/g;

    function vendorizeLine(line, prefix) {
      return line.replace(vendoredProperties, prefix + '-$1')
    }

    function addVendorPrefixesAndRemoveNewlines(css) {
      var resultLines = [];
      var sourceLines = css.split('\n');
      for (var i = 0; i < sourceLines.length; i++) {
        var line = sourceLines[i];
        if (line.match(/keyframes/)) {
          // Gather the entire @keyframes directive into a single line
          var braceCount = 1;
          i += 1;
          var keyframeLines = [line];
          while (braceCount > 0 && i < sourceLines.length) {
            line = sourceLines[i];
            keyframeLines.push(line);

            braceCount += line.match(/{/) ? line.match(/{/g).length : 0;
            braceCount -= line.match(/}/) ? line.match(/}/g).length : 0;

            i++;
          }
          line = keyframeLines.join('');
        }
        if (line.match(vendoredProperties)) {
          resultLines.push(vendorizeLine(line, '-moz'));
          resultLines.push(vendorizeLine(line, '-webkit'));
        }
        resultLines.push(line);
      }
      return resultLines.join('');
    }

    $(document).ready(function () {
      function fullScriptText(raw_css, raw_js) {
        var cssText = raw_css.replace(/\r/g, '');

        cssText = addVendorPrefixesAndRemoveNewlines(cssText);

        var payloadText = "$('body').append($('<style>" + cssText + "</style>'));\n";
        payloadText += raw_js;

        return $('script.before').text() + payloadText + $('script.after').text();
      }

      function selectedScriptText() {
        return fullScriptText($('textarea.css').val(), $('textarea.js').val());
      }

      function addBookmarkletAsHref($el, script) {
        debugger;
        var crunched = crunch(script);
        $el.attr('href', 'javascript:' + crunched);
      }

      function recompile() {
        var $link = $('.bookmarklet a');
        addBookmarkletAsHref($link, selectedScriptText());
        $link.text($('.bookmarklet-name').val());
      }

      function scriptTagForScriptClass(scriptClass) {
        return {
          zoshaky: 'zotaty'
        }[scriptClass] || 'rotaty';
      }

      function getTriggerKey () {
        if ($('.trigger-by-key').prop('checked')) {
          return $('.trigger-key').val();
        } else {
          return 'z';
        }
      }

      function scriptElementFor(cssOrJs, scriptClass) {
        var $script = $('script.' + scriptClass + '-' + cssOrJs);
        if ($script.length === 0) {
          $script = $('script.' + scriptTagForScriptClass(scriptClass) + '-' + cssOrJs);
        }
        var scriptText = $script.text();
        scriptText = scriptText.replace(/^\s+/, '');
        scriptText = scriptText.replace(/\s+$/, "\n");
        scriptText = scriptText.replace('BOOKMARKLET_NAME', scriptClass);
        return scriptText.replace('TRIGGER_KEY', getTriggerKey());
      }

      function populateTextareas(scriptClass) {
        $('textarea.css').val(scriptElementFor('css', scriptClass));
        $('textarea.js').val(scriptElementFor('js', scriptClass));
      }

      populateTextareas('rotaty');

      var $alternatives = $('.alternatives li');
      $alternatives.each(function (ix, el) {
        var $el = $(el);
        var $link = $('<a></a>');

        var js = scriptElementFor('js', $el.text());
        var css = scriptElementFor('css', $el.text());

        var script = fullScriptText(css, js);
        addBookmarkletAsHref($link, script);
        $link.text($el.text());
        $el.empty().append($link)
      });

      function recompileWithName (bookmarkletName) {
        populateTextareas(bookmarkletName);
        $('.bookmarklet-name').val(bookmarkletName);
        recompile();
      }

      $alternatives.click(function () {
        recompileWithName($(this).text());
        return false;
      });

      $('.create-bookmarklet').click(recompile);
      $('.dump-source').click(function () {
        console.log(selectedScriptText());
      });
      $('.trigger-key').keyup(function () {
        recompileWithName($('.bookmarklet-name').val());
      });

      recompile();

      setInterval(function () {
        if (Math.floor(Math.random() * 2)) {
          $('.arrow-left').toggleClass('rotated');
        } else {
          $('.arrow-right').toggleClass('rotated');
        }
      }, 8000);
    });
  </script>
</head>

<body>

<div class='content'>
  <div class='bookmarklet'>
    <div class='arrow-left'>▶</div><a href="#"></a><div class='arrow-right'>◀</div>
    <p class='hint'>(Drag it to your bookmarks bar!)</p>
  </div>

  <h2>a bookmarklet to confuse or delight</h2>

  <textarea class='css'></textarea>
  <textarea class='js'></textarea>

  <div>
    <label><input class='trigger-by-key' type='checkbox' style="margin-right: 5px;">Trigger effect by mousing over and pressing</label><input class='trigger-key small' value='z' />
  </div>

  <div class='generator'>
    <label>Name: <input class='bookmarklet-name' type='text' value='rotaty'></label>
    <button class='create-bookmarklet'>Recompile Bookmarklet</button>
    <button class='dump-source'>Log source to console</button>
  </div>

  <h2>or click one of these fine links to try a prebuilt alternative</h2>

  <ul class='alternatives'>
    <li>turnover</li>
    <li>mirrory</li>
    <li>flippy</li>
    <li>rotaty</li>
    <li>trippy</li>
    <li>blurry</li>
    <li>inverty</li>
    <li>zotaty</li>
    <li>zoshaky</li>
  </ul>

  <div class='bubble'>
    <h2>Serving Suggestions</h2>
    <ul>
      <li>Make <em>delay</em> really short for an intense experience in seasickness. (You can get the same effect by clicking the bookmarklet a lot.)</li>
      <li>Sneak this code into a project your colleague is working on but crank <em>delay</em> up really high. See if they are eventually driven insane.</li>
      <li>Replace <em>selector</em> with something interesting and site-specific for a tailored experience.</li>
      <li>Change <em>360deg</em> to <em>180deg</em> and watch a page turn itself upside out and back.</li>
      <li><em>rotateX</em> and <em>rotateY</em> are excellent drop-in substitutes for <em>rotate</em>.</li>
    </ul>
  </div>

</div>
</body>
</html>